<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>웹 접근성 BEM 다중/이중 다이얼로그</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h1>BEM 기반 웹 접근성 다중/이중 다이얼로그 예제</h1>

    <div class="button-container">
        <h2>다이얼로그 컨트롤 버튼</h2>
        <!-- 첫 번째 다이얼로그를 여는 버튼 -->
        <button id="openTermsDialogBtn" class="btn btn--primary">약관 보기 (메인 다이얼로그)</button>
        <!-- 두 번째 독립적인 다이얼로그를 여는 버튼 -->
        <button id="openInfoDialogBtn" class="btn btn--secondary">정보 알림 (독립 다이얼로그)</button>
    </div>

    <!-- 다이얼로그(모달) 마크업 1: 약관 동의 다이얼로그 -->
    <div id="termsDialog" class="dialog" role="dialog" aria-modal="true" aria-labelledby="termsDialogTitle">
        <div class="dialog__content">
            <h2 id="termsDialogTitle" class="dialog__title">개인정보 수집 및 이용 동의</h2>
            <p id="termsDialogDescription" class="sr-only">본 약관은 개인정보 수집 및 이용에 관한 내용입니다. (스크린 리더로 읽어주는 내용)</p>
            <div class="dialog__body">
                <p class="dialog__body-text">본 약관에 동의하지 않으시면 서비스 이용이 제한될 수 있습니다. 중요한 약관 내용이므로 신중히 검토해 주시기 바랍니다.</p>
                <p>... 금융 서비스 약관 내용 상세 ...</p>
                <p><strong>제 1조 (목적)</strong> 이 약관은 [회사명] (이하 "회사")이 제공하는 [서비스명] 서비스 이용과 관련하여 회사와 회원 간의 권리, 의무 및 책임사항, 기타 필요한 사항을 규정함을 목적으로 합니다.</p>
                <!-- 중첩 다이얼로그를 여는 버튼 추가 -->
                <button id="openNestedDialogBtn" class="btn btn--secondary">상세 보기 (중첩 다이얼로그)</button>
            </div>
            <div class="dialog__actions">
                <button id="termsConfirmBtn" class="btn btn--primary">동의</button>
                <button class="dialog__close-btn" aria-label="닫기">×</button>
            </div>
        </div>
    </div>

    <!-- 다이얼로그(모달) 마크업 2: 독립적인 정보 알림 다이얼로그 -->
    <div id="infoDialog" class="dialog" role="dialog" aria-modal="true" aria-labelledby="infoDialogTitle">
        <div class="dialog__content">
            <h2 id="infoDialogTitle" class="dialog__title">공지사항</h2>
            <p id="infoDialogDescription" class="sr-only">이것은 중요한 공지사항입니다.</p>
            <div class="dialog__body">
                <p class="dialog__body-text">새로운 보안 업데이트가 적용되었습니다. 서비스 이용에 참고해 주시기 바랍니다.</p>
                <p>자세한 내용은 고객센터를 통해 확인하실 수 있습니다.</p>
            </div>
            <div class="dialog__actions">
                <button class="btn btn--primary">확인했습니다</button>
                <button class="dialog__close-btn" aria-label="닫기">×</button>
            </div>
        </div>
    </div>

    <!-- 다이얼로그(모달) 마크업 3: 중첩 다이얼로그 (메인 약관 다이얼로그 안에서 열림) -->
    <div id="nestedDialog" class="dialog dialog--nested" role="dialog" aria-modal="true" aria-labelledby="nestedDialogTitle">
        <div class="dialog__content">
            <h2 id="nestedDialogTitle" class="dialog__title">추가 약관 상세</h2>
            <p id="nestedDialogDescription" class="sr-only">메인 약관 다이얼로그에서 열린 추가 상세 약관입니다.</p>
            <div class="dialog__body">
                <p class="dialog__body-text">여기에는 메인 약관에 대한 더 깊이 있는 세부 정보가 포함됩니다.</p>
                <p>예: 제 3조 (개인정보 보호 의무) 회사는 관계 법령이 정하는 바에 따라 회원의 개인정보를 보호하기 위해 노력하며...</p>
                <p>... 더 많은 상세 약관 ...</p>
            </div>
            <div class="dialog__actions">
                <button class="btn btn--secondary">이해했습니다</button>
                <button class="dialog__close-btn" aria-label="닫기">×</button>
            </div>
        </div>
    </div>
    
    <p>... 아래에 다른 컨텐츠들이 있습니다. 스크롤을 내려보세요. 모달이 열리면 스크롤이 잠깁니다. ...</p>
    <div style="height: 1500px; background-color: #e6f7ff; padding: 20px; border-radius: 8px; margin-top: 20px;">
        <h3>여기는 뒷 배경 컨텐츠입니다.</h3>
        <p>모달이 열리면 이 영역의 스크롤은 비활성화됩니다.</p>
        <p>스크롤을 테스트하기 위해 충분히 긴 내용을 추가했습니다.</p>
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ullam perferendis eligendi, recusandae sapiente quae fugit non error, ducimus illum quos debitis rerum laudantium vero vel, ab consectetur distinctio obcaecati reiciendis!</p>
        <p>Voluptate, eveniet! Provident, dolorum illum! Minus perferendis consectetur, ducimus dignissimos animi sequi. Ipsa, non! Provident fuga perferendis temporibus! Facere totam architecto dignissimos. Quo, reiciendis. Dolorum, eaque. Doloremque, rerum fuga?</p>
        <p>Tempora ipsam vero quas obcaecati laboriosam iste voluptatibus. Numquam, officia? Aliquam, voluptatem! Voluptatum, recusandae nisi. Laudantium, molestiae! Repudiandae reiciendis doloremque ea voluptatibus quam cumque est non, veritatis sint!</p>
        <p>Quidem perferendis, eum dolor error cumque voluptatibus distinctio in consectetur odit unde quas ipsam, dolores officiis aut! Voluptatem sint, reiciendis quia voluptatum nulla omnis ab cumque magnam eveniet. Accusantium, quod.</p>
        <p>Earum, iste culpa maiores nemo aliquid animi commodi distinctio! Quae modi quos alias sint sequi, eum, minus rerum ducimus iste tempora id vero laboriosam excepturi. Dolorum iusto at animi. Fugit?</p>
        <p>... 스크롤 테스트용 컨텐츠 계속 ...</p>
    </div>

    <script>
        /**
         * Button 컴포넌트 클래스
         * BEM 명명 규칙 및 웹 접근성을 준수합니다.
         */
        class Button {
            constructor(element, options = {}) {
                this.buttonElement = element;
                this.options = {
                    type: options.type || 'default', // 'primary', 'secondary', 'default'
                    initialState: options.initialState || {}, // { disabled: true, active: false }
                    onClick: options.onClick || (() => {})
                };

                this._init();
                this._addEventListeners();
            }

            _init() {
                // 초기 타입 클래스 적용
                if (this.options.type === 'primary') {
                    this.buttonElement.classList.add('btn--primary');
                } else if (this.options.type === 'secondary') {
                    this.buttonElement.classList.add('btn--secondary');
                }
                // 'button' 블록 클래스는 HTML에 미리 추가되어 있다고 가정

                // 초기 상태 적용
                if (this.options.initialState.disabled) {
                    this.disable();
                }
                if (this.options.initialState.active) {
                    this.activate();
                }
            }

            _addEventListeners() {
                this.buttonElement.addEventListener('click', this.options.onClick);
            }

            /**
             * 버튼을 활성화합니다. disabled 속성을 제거하고 관련 클래스를 제거합니다.
             */
            enable() {
                this.buttonElement.disabled = false;
                this.buttonElement.classList.remove('btn--disabled');
            }

            /**
             * 버튼을 비활성화합니다. disabled 속성을 추가하고 관련 클래스를 추가합니다.
             */
            disable() {
                this.buttonElement.disabled = true;
                this.buttonElement.classList.add('btn--disabled');
            }

            /**
             * 버튼을 활성(Active) 상태로 만듭니다. (시각적 피드백용)
             */
            activate() {
                this.buttonElement.classList.add('btn--active');
            }

            /**
             * 버튼의 활성(Active) 상태를 해제합니다.
             */
            deactivate() {
                this.buttonElement.classList.remove('btn--active');
            }

            /**
             * 버튼 클릭 시 실행될 콜백 함수를 변경합니다.
             * @param {function} newCallback - 새로운 클릭 이벤트 핸들러
             */
            setOnClickListener(newCallback) {
                this.buttonElement.removeEventListener('click', this.options.onClick);
                this.options.onClick = newCallback;
                this.buttonElement.addEventListener('click', this.options.onClick);
            }
        }


        /**
         * Dialog (Modal) 컴포넌트 클래스
         * BEM 명명 규칙, 웹 접근성, body 스크롤 제어를 준수합니다.
         * 여러 다이얼로그가 열려도 body 스크롤이 유지되다가
         * 모든 다이얼로그가 닫혀야만 body 스크롤이 다시 활성화됩니다.
         */
        class Dialog {
            constructor(element, options = {}) {
                this.dialogElement = element;
                this.openButton = options.openBtn; // 다이얼로그를 여는 버튼 (선택 사항)
                this.closeButton = this.dialogElement.querySelector('.dialog__close-btn');
                this.confirmButton = this.dialogElement.querySelector('.dialog__actions .btn--primary'); // 확인 버튼 (다이얼로그 액션 내부)

                this.previouslyFocusedElement = null; // 다이얼로그 열기 전 포커스 요소
                this.focusableElements = []; // 다이얼로그 내부에서 포커스 가능한 요소들

                this._addEventListeners();
            }

            _addEventListeners() {
                if (this.openButton) {
                    this.openButton.addEventListener('click', this.open.bind(this));
                }
                this.closeButton.addEventListener('click', this.close.bind(this));
                // 확인 버튼 클릭 시 다이얼로그 닫기 (예시)
                if (this.confirmButton) {
                    this.confirmButton.addEventListener('click', this.close.bind(this));
                }
                document.addEventListener('keydown', this._handleKeyDown.bind(this));
            }

            /**
             * 다이얼로그를 엽니다.
             * - `dialog--is-open` 클래스 추가
             * - `body--no-scroll` 클래스 추가 (스크롤 방지)
             * - 포커스 트랩 설정 및 첫 포커스 요소로 이동
             */
            open() {
                this.previouslyFocusedElement = document.activeElement; // 열기 전 포커스 저장
                this.dialogElement.classList.add('dialog--is-open');
                
                // 모든 다이얼로그를 통틀어 처음 열리는 경우에만 body 스크롤 막기
                if (document.querySelectorAll('.dialog--is-open').length === 1) {
                    document.body.classList.add('body--no-scroll');
                }
                
                this._trapFocus();
                this.closeButton.focus(); // 닫기 버튼으로 초기 포커스 이동
            }

            /**
             * 다이얼로그를 닫습니다.
             * - `dialog--is-open` 클래스 제거
             * - `body--no-scroll` 클래스 제거 (스크롤 허용)
             * - 원래 포커스 위치로 복원
             */
            close() {
                this.dialogElement.classList.remove('dialog--is-open');
                
                // 모든 다이얼로그를 통틀어 마지막 다이얼로그가 닫히는 경우에만 body 스크롤 허용
                if (document.querySelectorAll('.dialog--is-open').length === 0) {
                    document.body.classList.remove('body--no-scroll');
                }

                if (this.previouslyFocusedElement) {
                    this.previouslyFocusedElement.focus();
                }
            }

            /**
             * 다이얼로그 내부에서 포커스 가능한 요소들을 찾아 배열에 저장합니다.
             */
            _trapFocus() {
                const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
                this.focusableElements = Array.from(this.dialogElement.querySelectorAll(focusableSelectors))
                                            .filter(el => !el.disabled && el.offsetParent !== null); // 비활성화되거나 숨겨진 요소 제외

                // 포커스 가능한 요소가 없는 경우를 대비 (최소한 닫기 버튼은 있어야 함)
                if (this.focusableElements.length === 0 && this.closeButton) {
                    this.focusableElements.push(this.closeButton);
                }

                this.firstFocusableElement = this.focusableElements[0];
                this.lastFocusableElement = this.focusableElements[this.focusableElements.length - 1];
            }

            /**
             * 키보드 이벤트 (ESC, Tab) 처리 핸들러
             * - ESC 키로 다이얼로그 닫기
             * - Tab 키로 다이얼로그 내부에서 포커스 순환 (Focus Trap)
             * @param {KeyboardEvent} event
             */
            _handleKeyDown(event) {
                if (!this.dialogElement.classList.contains('dialog--is-open')) return;

                // ESC 키로 닫기
                if (event.key === 'Escape' || event.key === 'Esc') {
                    this.close();
                    event.preventDefault(); // 기본 ESC 동작 방지
                    return;
                }

                // TAB 키로 포커스 순환
                if (event.key === 'Tab') {
                    const isFirstElementFocused = document.activeElement === this.firstFocusableElement;
                    const isLastElementFocused = document.activeElement === this.lastFocusableElement;

                    if (event.shiftKey) { // Shift + Tab (역방향)
                        if (isFirstElementFocused) {
                            this.lastFocusableElement.focus();
                            event.preventDefault(); // 기본 Tab 동작 방지
                        }
                    } else { // Tab (정방향)
                        if (isLastElementFocused) {
                            this.firstFocusableElement.focus();
                            event.preventDefault(); // 기본 Tab 동작 방지
                        }
                    }
                }
            }
        }


        // DOMContentLoaded 이벤트 발생 시 컴포넌트 초기화
        document.addEventListener('DOMContentLoaded', () => {
            // =========================================================
            // Dialog 컴포넌트 초기화
            // =========================================================

            // 1. 메인 약관 다이얼로그 (termsDialog)
            const termsDialogElement = document.getElementById('termsDialog');
            const openTermsDialogBtn = document.getElementById('openTermsDialogBtn');
            const termsDialog = new Dialog(termsDialogElement, {
                openBtn: openTermsDialogBtn // 메인 약관 다이얼로그를 여는 버튼
            });

            // 2. 독립적인 정보 알림 다이얼로그 (infoDialog)
            const infoDialogElement = document.getElementById('infoDialog');
            const openInfoDialogBtn = document.getElementById('openInfoDialogBtn');
            const infoDialog = new Dialog(infoDialogElement, {
                openBtn: openInfoDialogBtn // 정보 알림 다이얼로그를 여는 버튼
            });

            // 3. 중첩 다이얼로그 (nestedDialog)
            const nestedDialogElement = document.getElementById('nestedDialog');
            const openNestedDialogBtn = document.getElementById('openNestedDialogBtn');
            const nestedDialog = new Dialog(nestedDialogElement, {
                openBtn: openNestedDialogBtn // 중첩 다이얼로그를 여는 버튼 (termsDialog 안에 있음)
            });

            // =========================================================
            // Button 컴포넌트 초기화 및 테스트 (다른 일반 버튼들)
            // =========================================================

            // 일반 버튼 (클래스 없음)
            new Button(document.getElementById('normalPrimaryBtn'), {
                type: 'primary',
                onClick: () => console.log('일반 프라이머리 버튼 클릭!')
            });

            // 활성 버튼 (초기 상태가 활성)
            const activePrimaryBtn = new Button(document.getElementById('activePrimaryBtn'), {
                type: 'primary',
                initialState: { active: true },
                onClick: () => console.log('활성 프라이머리 버튼 클릭!')
            });

            // 비활성 버튼 (초기 상태가 비활성)
            const disabledPrimaryBtn = new Button(document.getElementById('disabledPrimaryBtn'), {
                type: 'primary',
                initialState: { disabled: true },
                onClick: () => console.log('비활성 프라이머리 버튼 클릭!')
            });

            // 활성 세컨더리 버튼
            const activeSecondaryBtn = new Button(document.getElementById('activeSecondaryBtn'), {
                type: 'secondary',
                initialState: { active: true },
                onClick: () => console.log('활성 세컨더리 버튼 클릭!')
            });

            // 비활성 세컨더리 버튼
            const disabledSecondaryBtn = new Button(document.getElementById('disabledSecondaryBtn'), {
                type: 'secondary',
                initialState: { disabled: true },
                onClick: () => console.log('비활성 세컨더리 버튼 클릭!')
            });

            // 활성/비활성 토글 버튼
            const toggleActiveBtn = new Button(document.getElementById('toggleActiveBtn'), {
                type: 'secondary',
                onClick: (event) => {
                    if (event.currentTarget.classList.contains('btn--active')) {
                        toggleActiveBtn.deactivate();
                        console.log('활성 상태 해제');
                    } else {
                        toggleActiveBtn.activate();
                        console.log('활성 상태 설정');
                    }
                }
            });

            // 비활성(disabled 속성) 토글 버튼
            const toggleDisableBtn = new Button(document.getElementById('toggleDisableBtn'), {
                type: 'primary',
                onClick: (event) => {
                    if (event.currentTarget.disabled) {
                        toggleDisableBtn.enable();
                        console.log('버튼 활성화');
                    } else {
                        toggleDisableBtn.disable();
                        console.log('버튼 비활성화');
                    }
                }
            });
        });
    </script>
</body>
</html>
